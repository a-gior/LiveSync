import { window, Uri, commands } from "vscode";
import { Panel } from "./Panel";

import { ConfigurationState } from "@shared/DTOs/states/ConfigurationState";
import { SFTPClient } from "../services/SFTPClient";
import { PairFoldersMessage } from "@shared/DTOs/messages/PairFoldersMessage";
import * as fs from "fs";
import { FullConfigurationMessage } from "@shared/DTOs/messages/FullConfigurationMessage";
import { FileEventActionsMessage } from "@shared/DTOs/messages/FileEventActionsMessage";
import { ConnectionManager } from "../managers/ConnectionManager";
import { SSHClient } from "../services/SSHClient";
import { IgnoreListMessage } from "../DTOs/messages/IgnoreListMessage";
import { WorkspaceConfigManager } from "../managers/WorkspaceConfigManager";

export class ConfigurationPanel extends Panel {
  static render(extensionUri: Uri) {
    const viewType = "configurationViewType";
    const title = "Configuration";
    const localResourceRoots = [
      Uri.joinPath(extensionUri, "out"),
      Uri.joinPath(extensionUri, "resources"),
      Uri.joinPath(extensionUri, "webview-ui/public/build"),
    ];
    const configurationCallback = async (message: FullConfigurationMessage) => {
      switch (message.command) {
        case "updateConfiguration":
          console.log("Update all configurations...");
          await this.updateConfiguration(message);
          break;
        case "testConnection":
          console.log("TestConnection...");
          if (message.configuration) {
            await commands.executeCommand(
              "livesync.testConnection",
              message.configuration,
            );
          }
          break;
        case "savePairFolders":
          break;
      }
    };
    const filepaths = [
      "resources/css/reset.css",
      "resources/css/vscode.css",
      "webview-ui/public/build/pages/configuration/configuration.css", // generated by compiling svelte with rollup
      "webview-ui/public/build/pages/configuration/configuration.js", // generated by compiling svelte with rollup
    ];

    // Call the render method from the parent class with additional parameters
    super.render(
      extensionUri,
      viewType,
      title,
      localResourceRoots,
      filepaths,
      configurationCallback,
      // Additional options if needed
    );

    const allWorkspaceConfig: FullConfigurationMessage = {
      command: "setInitialConfiguration",
      ...WorkspaceConfigManager.getWorkspaceConfiguration(),
    };
    this.currentPanel?.getPanel().webview.postMessage(allWorkspaceConfig);
  }

  static async savePairFolders(
    pairedFoldersArr: PairFoldersMessage["paths"][],
  ) {
    console.log("pairedFoldersArr", pairedFoldersArr);
    const configuration = WorkspaceConfigManager.getRemoteServerConfigured();

    const connectionManager = ConnectionManager.getInstance(configuration);
    connectionManager
      .doSFTPOperation(async (sftpClient: SFTPClient) => {
        for (const pairedFolders of pairedFoldersArr) {
          const { localPath, remotePath } = pairedFolders;
          if (!(await sftpClient.pathExists(remotePath))) {
            console.error(
              `Remote folder not found. Local path: ${localPath} & remote path: ${remotePath}`,
            );
            window.showErrorMessage(`Remote folder ${remotePath} not found`);
            return;
          } else if (!fs.existsSync(localPath)) {
            console.error(
              `Local folder not found. Local path: ${localPath} & remote path: ${remotePath}`,
            );
            window.showErrorMessage(`Local folder ${localPath} not found`);
            return;
          } else {
            console.log("Paired Folders are valid");
          }
        }
      }, "Saving PairedFolders")
      .then(async () => {
        // All good so we update the pairedFolders config
        await WorkspaceConfigManager.update("pairedFolders", pairedFoldersArr);
        console.log("Paired Folders are saved");
        window.showInformationMessage("Paired Folders are valid and saved");
      });
  }

  static async saveFileEventActions(
    actions: FileEventActionsMessage["actions"],
  ) {
    console.log("saveActions", actions);
    if (actions) {
      await WorkspaceConfigManager.batchUpdate({
        actionOnUpload: actions.actionOnUpload,
        actionOnDownload: actions.actionOnDownload,
        actionOnSave: actions.actionOnSave,
        actionOnCreate: actions.actionOnCreate,
        actionOnDelete: actions.actionOnDelete,
        actionOnMove: actions.actionOnMove,
        actionOnOpen: actions.actionOnOpen,
      });

      console.log("File event actions saved successfully.");
      window.showInformationMessage("File event actions saved.");
    } else {
      window.showErrorMessage(
        "No configuration found or missing properties. Please configure LiveSync correctly.",
      );
      return;
    }
  }

  static async saveRemoteServerConfiguration(
    configuration: ConfigurationState["configuration"],
  ): Promise<void> {
    if (configuration) {
      const connectionManager = ConnectionManager.getInstance(configuration);

      connectionManager
        .doSSHOperation(async (sshClient: SSHClient) => {
          sshClient.waitForConnection();
        }, "Test Connection")
        .then(async () => {
          const { hostname, port, username, authMethod, password, sshKey } =
            configuration;

          await WorkspaceConfigManager.batchUpdate({
            hostname,
            port,
            username,
            authMethod,
            password,
            sshKey,
          });

          console.log("Remote server configuration saved successfully.");
          window.showInformationMessage("Remote server configuration saved.");
        })
        .catch((err: any) => {
          console.error("Remote server configuration couldnt be saved.", err);
          window.showErrorMessage(
            `Remote server configuration couldn't be saved. \n${err.message}`,
          );
          throw err;
        });
    } else {
      window.showErrorMessage(
        "No configuration found or missing properties. Please configure LiveSync correctly.",
      );
      return Promise.reject(new Error("Invalid configuration"));
    }
  }

  static async saveIgnoreList(ignoreList: IgnoreListMessage["ignoreList"]) {
    console.log(`<saveIgnoreList> list: `, ignoreList);

    if (ignoreList) {
      try {
        await WorkspaceConfigManager.update("ignoreList", ignoreList);
        console.log("Ignore list saved successfully.");
        window.showInformationMessage("Ignore list saved successfully.");
      } catch (error) {
        console.error("Error saving ignore list: ", error);
        window.showErrorMessage(
          "Failed to save ignore list. See console for details.",
        );
      }
    } else {
      window.showErrorMessage(
        "No configuration found or missing properties. Please configure LiveSync correctly.",
      );
    }
  }

  static async updateConfiguration(configuration: FullConfigurationMessage) {
    if (configuration.configuration) {
      this.saveRemoteServerConfiguration(configuration.configuration);
    }
    if (configuration.pairedFolders) {
      this.savePairFolders(configuration.pairedFolders);
    }
    if (configuration.fileEventActions) {
      this.saveFileEventActions(configuration.fileEventActions);
    }
    if (configuration.ignoreList) {
      this.saveIgnoreList(configuration.ignoreList);
    }
  }
}
